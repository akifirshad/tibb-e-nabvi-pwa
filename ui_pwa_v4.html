<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<link rel="manifest" href="./manifest.json">
<title>Tibb-e-Nabvi â€” Explorer (v4)</title>
<style>
:root{
  --bg-light:#fbfdf9; --panel-light:#ffffff; --text-light:#0b1a1a; --muted-light:#556066;
  --accent:#10b981; --accent-2:#7c3aed;
  --bg-dark:#071026; --panel-dark:#0b1220; --text-dark:#e6eef6; --muted-dark:#94a3b8;
  --radius:12px; --shadow: 0 6px 20px rgba(2,6,8,0.06);
  font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
}
:root[data-theme="light"]{
  --bg:var(--bg-light); --panel:var(--panel-light); --text:var(--text-light); --muted:var(--muted-light);
  --glass: rgba(2,6,8,0.03); --glass-2: rgba(2,6,8,0.01); --glass-border: rgba(2,6,8,0.06);
}
:root[data-theme="dark"]{
  --bg:var(--bg-dark); --panel:var(--panel-dark); --text:var(--text-dark); --muted:var(--muted-dark);
  --glass: rgba(255,255,255,0.03); --glass-2: rgba(255,255,255,0.02); --glass-border: rgba(255,255,255,0.04);
}
*{box-sizing:border-box}
html,body{height:100%; margin:0; background:var(--bg); color:var(--text); -webkit-font-smoothing:antialiased;}
.app{min-height:100vh; display:flex; flex-direction:column; gap:12px; padding:12px;}
.header{display:flex; align-items:center; justify-content:space-between; gap:12px}
.brand{display:flex; gap:12px; align-items:center}
.logo{width:46px;height:46px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;font-weight:800;color:#021}
.title{font-weight:800;font-size:17px}
.subtitle{font-size:13px;color:var(--muted)}

/* controls */
.controls{display:flex; gap:8px; align-items:center}
.btn{background:var(--panel); border:1px solid var(--glass-border); padding:10px 12px; border-radius:10px; cursor:pointer; color:var(--muted); font-weight:700}
.icon-btn{width:44px;height:44px;display:inline-flex;align-items:center;justify-content:center;border-radius:10px}

/* search & segmented body */
.top-block{display:flex; flex-direction:column; gap:8px}
.search{width:100%}
.search input{width:100%; padding:12px 14px; border-radius:12px; border:1px solid var(--glass-border); background:var(--panel); color:var(--text); font-size:15px}

/* segmented body selection */
.segment-tabs{display:flex; gap:8px; overflow:auto;}
.segment{flex:0 0 auto;padding:8px 12px;border-radius:999px;border:1px solid transparent;background:transparent;color:var(--muted);cursor:pointer}
.segment.active{background:linear-gradient(90deg, rgba(16,185,129,0.12), rgba(124,58,237,0.04)); color:var(--text); border:1px solid var(--glass-border)}

/* body diagram area */
.diagram{display:flex; gap:12px; align-items:center; justify-content:center; padding:8px}
.diagram svg{max-width:100%; height:220px; touch-action: manipulation}
.zone{fill:transparent; stroke:var(--muted); stroke-width:1.2; cursor:pointer; transition:all .18s}
.zone:hover{stroke:var(--accent); stroke-width:1.6}

/* content area */
.content{display:grid; gap:12px; grid-template-columns:1fr; margin-top:6px}
@media(min-width:900px){ .content{grid-template-columns: 320px 1fr} .left-panel{position:sticky; top:20px; align-self:start} }

.left-panel{display:flex; flex-direction:column; gap:8px}
.tabs{display:flex; gap:8px; overflow:auto; padding:8px 2px}
.tab{flex:0 0 auto;padding:10px 12px;border-radius:10px;background:transparent;border:1px solid transparent;color:var(--muted);cursor:pointer}
.tab.active{background:linear-gradient(90deg, rgba(16,185,129,0.12), rgba(124,58,237,0.04)); color:var(--text); border:1px solid var(--glass-border)}

/* cards */
.cards{display:grid; gap:12px}
.card{display:flex; gap:10px; align-items:flex-start; padding:12px; border-radius:12px; background:var(--panel); border:1px solid var(--glass); box-shadow:var(--shadow)}
.thumb{width:84px; height:84px; border-radius:10px; background:var(--glass-2); overflow:hidden; flex-shrink:0; display:flex; align-items:center; justify-content:center}
.thumb img{width:100%; height:100%; object-fit:cover}
.card-body{flex:1}
.card-title{font-weight:700; margin-bottom:6px}
.pill{display:inline-block;padding:6px 8px;border-radius:999px;border:1px solid var(--glass-border); color:var(--muted);font-size:12px;cursor:pointer}

/* loader & modal */
.loader{display:flex;align-items:center;gap:10px;justify-content:center;padding:18px}
.spinner{width:28px;height:28px;border-radius:999px;border:4px solid rgba(0,0,0,0.06);border-top-color:var(--accent);animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

.modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.35);display:flex;align-items:center;justify-content:center;z-index:9999}
.modal{width:92%;max-width:420px;background:var(--panel);border-radius:12px;padding:18px;border:1px solid var(--glass-border);box-shadow:var(--shadow)}

/* small */
.small{font-size:13px;color:var(--muted)}

/* empty */
.empty{padding:30px;text-align:center;color:var(--muted)}

</style>
</head>
<body data-theme="light">
<div class="app" id="app">
  <div class="header">
    <div class="brand">
      <div class="logo">T</div>
      <div>
        <div class="title">Tibb-e-Nabvi Explorer</div>
        <div class="subtitle">Traditional remedies â€” interactive</div>
      </div>
    </div>
    <div class="controls">
      <button id="themeToggle" class="icon-btn btn" title="Toggle theme">ðŸŒ™</button>
      <button id="langBtn" class="btn">EN</button>
      <button id="installBtn" class="btn">Install</button>
    </div>
  </div>

  <div class="top-block">
    <div class="search"><input id="searchInput" placeholder="Search disease, remedy or body part..." aria-label="Search"></div>
    <div class="segment-tabs" id="segmentTabs" role="tablist" aria-label="Body segments">
      <button class="segment active" data-seg="head">Head</button>
      <button class="segment" data-seg="torso">Torso</button>
      <button class="segment" data-seg="limbs">Limbs</button>
      <button class="segment" data-seg="skin">Skin</button>
    </div>

    <div class="diagram" id="diagram">
      <!-- Simple SVG segmented body: head, torso, limbs, skin (clickable zones) -->
      <svg viewBox="0 0 200 420" width="220" height="420" role="img" aria-label="Body diagram">
        <!-- head -->
        <g id="zone-head" class="zone" data-zone="head">
          <circle cx="100" cy="48" r="36" stroke-linecap="round" stroke-linejoin="round"></circle>
        </g>
        <!-- torso -->
        <g id="zone-torso" class="zone" data-zone="torso">
          <rect x="58" y="94" width="84" height="120" rx="20" ry="20"></rect>
        </g>
        <!-- limbs (arms+legs simplified) -->
        <g id="zone-limbs" class="zone" data-zone="limbs">
          <rect x="22" y="94" width="20" height="180" rx="10"></rect>
          <rect x="158" y="94" width="20" height="180" rx="10"></rect>
          <rect x="78" y="214" width="20" height="160" rx="10"></rect>
          <rect x="102" y="214" width="20" height="160" rx="10"></rect>
        </g>
        <!-- skin (overlay rectangle) -->
        <g id="zone-skin" class="zone" data-zone="skin">
          <rect x="12" y="12" width="176" height="396" rx="16" ry="16" opacity="0.02"></rect>
        </g>
      </svg>
    </div>
  </div>

  <div class="content">
    <div class="left-panel">
      <div class="tabs" id="bodyList"></div>
      <div class="small">Tip: tap body zones or pills on cards to filter.</div>
    </div>

    <div>
      <div id="mainArea">
        <div class="loader" id="loader"><div class="spinner"></div><div id="loaderText">Loadingâ€¦</div></div>
        <div class="empty" id="emptyState" style="display:none">Select a body part to begin or search above.</div>
        <div class="cards" id="cards" aria-live="polite"></div>
      </div>
    </div>
  </div>
</div>

<!-- Install modal (hidden) -->
<div id="installModal" style="display:none" aria-hidden="true"></div>

<script>
// v4 interactive UI script with segmented body, search, filters, theme, install modal, and improved SW handling

const DATA_INDEX = 'data/index.json';

// Elements
const appEl = document.body;
const loader = document.getElementById('loader');
const loaderText = document.getElementById('loaderText');
const emptyState = document.getElementById('emptyState');
const cardsEl = document.getElementById('cards');
const bodyListEl = document.getElementById('bodyList');
const searchInput = document.getElementById('searchInput');
const segmentTabs = document.getElementById('segmentTabs');
const segmentButtons = Array.from(document.querySelectorAll('.segment'));
const diagram = document.getElementById('diagram');
const installBtn = document.getElementById('installBtn');
const installModal = document.getElementById('installModal');
const themeToggle = document.getElementById('themeToggle');
const langBtn = document.getElementById('langBtn');

let datasets = {};
let indexFiles = [];
let currentFilter = null; // body part filter name or segment
let currentLang = 'en';
let locales = {};

// debounce helper
function debounce(fn, wait=220){ let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), wait); }; }

// i18n loader
const availableLangs = ['en','ar','ur','zh','fr','ja','es','ru'];
async function loadLocale(code){ if(locales[code]) return locales[code]; try{ const r = await fetch('./locales/'+code+'.json'); if(!r.ok) throw new Error('no locale'); const j = await r.json(); locales[code]=j; return j;}catch(e){ locales[code]=locales['en']||{}; return locales[code]; } }
function t(key){ return (locales[currentLang] && locales[currentLang][key]) || (locales['en'] && locales['en'][key]) || key; }

// theme
function applyTheme(theme){ document.documentElement.setAttribute('data-theme', theme); localStorage.setItem('tibb_theme', theme); themeToggle.textContent = theme === 'dark' ? 'â˜€ï¸' : 'ðŸŒ™'; }
function initTheme(){ const s = localStorage.getItem('tibb_theme'); if(s) applyTheme(s); else applyTheme('light'); }
themeToggle.addEventListener('click', ()=>{ const cur = document.documentElement.getAttribute('data-theme')==='dark' ? 'dark' : 'light'; applyTheme(cur==='dark' ? 'light' : 'dark'); });

// Install flow - always show install button; use beforeinstallprompt if available
let deferredPrompt = null;
window.addEventListener('beforeinstallprompt', (e)=>{ e.preventDefault(); deferredPrompt = e; });
installBtn.addEventListener('click', ()=>{ showInstallModal(); if(deferredPrompt){ deferredPrompt.prompt(); deferredPrompt.userChoice.then(()=>{ deferredPrompt=null; }); } });

function showInstallModal(){
  const theme = document.documentElement.getAttribute('data-theme')==='dark' ? 'dark' : 'light';
  const bg = theme==='dark' ? 'rgba(0,0,0,0.6)' : 'rgba(0,0,0,0.45)';
  const modal = document.createElement('div');
  modal.className='modal-backdrop';
  modal.innerHTML = `<div class="modal" role="dialog" aria-modal="true">
    <div style="display:flex;align-items:center;gap:12px">
      <div style="width:56px;height:56px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;font-weight:800">T</div>
      <div style="flex:1">
        <div style="font-weight:800">Add Tibb-e-Nabvi to your Home Screen</div>
        <div class="small" style="margin-top:6px">Install the app for offline access and quick launching.</div>
      </div>
      <button class="btn" id="closeModal">Ã—</button>
    </div>
    <hr style="margin:12px 0;border:none;border-top:1px solid var(--glass-border)"/>
    <div class="small">On Android: tap <strong>â‹® (menu) â†’ Add to Home screen</strong> or accept the prompt.<br/>On iOS: tap <strong>Share â†’ Add to Home Screen</strong>.</div>
    <div style="display:flex;justify-content:flex-end;margin-top:12px"><button id="gotIt" class="btn">Got it</button></div>
  </div>`;
  modal.querySelector('#closeModal').onclick = ()=> modal.remove();
  modal.querySelector('#gotIt').onclick = ()=> modal.remove();
  // remove old and add
  const prev = document.querySelector('.modal-backdrop'); if(prev) prev.remove();
  document.body.appendChild(modal);
}

// service worker registration (improved cache) - register with scope
if('serviceWorker' in navigator){
  navigator.serviceWorker.register('./service-worker.js').then(reg=>{
    console.log('SW registered', reg);
    // listen for updates
    if(reg.waiting){ console.log('SW waiting'); }
    reg.addEventListener('updatefound', ()=>{ console.log('update found'); });
  }).catch(e=> console.warn('SW failed', e));
}

// initial boot
(async function boot(){
  initTheme();
  await loadLocale('en');
  const navLang = navigator.language ? navigator.language.split('-')[0] : 'en';
  if(availableLangs.includes(navLang)) currentLang = navLang;
  await loadLocale(currentLang);
  langBtn.textContent = currentLang.toUpperCase();

  showLoader(t('loading')||'Loadingâ€¦');
  try{
    const idxRes = await fetch(DATA_INDEX);
    if(!idxRes.ok) throw new Error('index.json missing');
    const idx = await idxRes.json();
    indexFiles = idx.files || idx || [];
    await loadDatasets(indexFiles);
    hideLoader();
    renderBodyList();
    renderSegments(); // attach events
    // select first dataset by default
    const first = Object.keys(datasets)[0];
    if(first) selectDataset(first);
    else showEmpty();
  }catch(err){
    console.error(err);
    showLoader('Failed to load data â€” ensure /data/index.json is present and accessible.');
    loader.onclick = ()=> location.reload();
  }
})();

async function loadDatasets(list){
  for(const f of list){
    try{
      const r = await fetch(f);
      if(!r.ok){ console.warn('missing', f); continue; }
      datasets[f] = await r.json();
    }catch(e){ console.warn('error', f, e); }
  }
}

// UI rendering
function renderBodyList(){
  bodyListEl.innerHTML='';
  for(const fname of Object.keys(datasets)){
    const bp = datasets[fname].body_part || fname.replace('.json','');
    const b = document.createElement('button');
    b.className='tab'; b.textContent = bp; b.title = fname;
    b.onclick = ()=> filterByBody(bp);
    bodyListEl.appendChild(b);
  }
}

function renderCards(list){
  cardsEl.innerHTML='';
  if(!list || list.length===0){ cardsEl.innerHTML = '<div class="empty">'+t('no_matches')+'</div>'; return; }
  const q = (searchInput.value||'').trim().toLowerCase();
  let shown=0;
  for(const item of list){
    const title = item.disease || 'â€”';
    const remedy = item.remedy || '';
    const hay = (title+' '+remedy+' '+(item.remedy_description||'')+' '+(item.method||'')+' '+(item.body_part||'')).toLowerCase();
    if(q && !hay.includes(q)) continue;
    if(currentFilter){
      // currentFilter can be a segment (head/torso/limbs/skin) or body part name
      const matchesSeg = matchSegment(item, currentFilter);
      if(!matchesSeg) continue;
    }
    shown++;
    const card = document.createElement('article'); card.className='card';
    const thumb = document.createElement('div'); thumb.className='thumb';
    if(item.remedy_image_url){ const img = document.createElement('img'); img.src=item.remedy_image_url; img.alt=item.remedy||title; thumb.appendChild(img); }
    else { thumb.innerHTML = '<div class="small">'+t('no_image')+'</div>'; }
    const body = document.createElement('div'); body.className='card-body';
    const h = document.createElement('div'); h.className='card-title'; h.textContent = title;
    const p = document.createElement('div'); p.className='small'; p.innerHTML = '<strong>Remedy:</strong> '+(remedy||'â€”');
    const meta = document.createElement('div'); meta.style.margin='8px 0';
    const bpPill = document.createElement('span'); bpPill.className='pill'; bpPill.textContent = item.body_part || 'Unknown'; bpPill.onclick = ()=> { clearSearch(); filterByBody(bpPill.textContent); };
    meta.appendChild(bpPill);
    if(item.dose){ const d = document.createElement('span'); d.className='pill'; d.style.marginLeft='8px'; d.textContent = (t('dose')||'Dose')+': '+item.dose; meta.appendChild(d); }
    const details = document.createElement('div'); details.className='small'; details.style.marginTop='8px'; details.innerHTML = escapeHtml(item.remedy_description||'') + '<div style="margin-top:6px"><strong>Method:</strong> '+escapeHtml(item.method||'â€”')+'</div>';
    const footer = document.createElement('div'); footer.style.display='flex'; footer.style.justifyContent='space-between'; footer.style.gap='8px'; footer.style.marginTop='10px';
    const more = document.createElement('a'); more.className='btn'; more.textContent = t('more_images')||'More images'; more.href = getMoreImagesLink(item.remedy_description); more.target='_blank';
    const dl = document.createElement('button'); dl.className='btn'; dl.textContent = t('download')||'Download'; dl.onclick = ()=> downloadDataset(item);
    footer.appendChild(more); footer.appendChild(dl);
    body.appendChild(h); body.appendChild(p); body.appendChild(meta); body.appendChild(details); body.appendChild(footer);
    card.appendChild(thumb); card.appendChild(body);
    cardsEl.appendChild(card);
  }
  if(shown===0) cardsEl.innerHTML = '<div class="empty">'+t('no_matches')+'</div>';
}

function matchSegment(item, seg){
  // map common body_part strings to segments (simple heuristic)
  const bp = (item.body_part||'').toLowerCase();
  if(!bp) return seg==='skin' ? true : false;
  if(seg==='head') return /head|brain|eyes|ear|nose|mouth|throat/.test(bp);
  if(seg==='torso') return /chest|heart|lung|torso|stomach|abdomen|liver|kidney|digest/.test(bp);
  if(seg==='limbs') return /arm|leg|hand|foot|shoulder|knee|elbow|limb/.test(bp);
  if(seg==='skin') return /skin|wound|rash|ulcer|boil|cutaneous/.test(bp);
  // fallback: if user filtered by exact body part name
  return bp.includes(seg.toLowerCase());
}

function selectDataset(fname){
  // highlight dataset tab in left panel
  [...bodyListEl.children].forEach(c=> c.classList.toggle('active', c.title===fname));
  const data = datasets[fname] || {diseases:[]};
  renderCards(data.diseases || []);
}

function filterByBody(name){
  // set currentFilter and re-render across all datasets combined
  currentFilter = name;
  // collect all diseases from all datasets
  let all = [];
  for(const k of Object.keys(datasets)) all = all.concat(datasets[k].diseases || []);
  renderCards(all);
  // highlight matching tab if exists
  [...bodyListEl.children].forEach(c=> c.classList.toggle('active', c.textContent===name));
}

function clearSearch(){ searchInput.value=''; }

function downloadDataset(item){
  // download current combined dataset (per body part file) rather than single item
  if(!item) return;
  // find dataset that contains this item by body_part
  let found = null;
  for(const k of Object.keys(datasets)){
    const arr = datasets[k].diseases || [];
    if(arr.some(a=> a.disease === item.disease)) { found = datasets[k]; break; }
  }
  const data = found || {diseases:[item]};
  const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download = (data.body_part||'data')+'.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}

function getMoreImagesLink(desc){ if(!desc) return 'https://commons.wikimedia.org'; const m = desc.match(/More images:\\s*(https?:\\/\\/[^\\s]+)/i); return m? m[1] : 'https://commons.wikimedia.org'; }
function escapeHtml(s){ if(!s) return ''; return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\\n/g,'<br/>'); }

function showLoader(text){ loader.style.display='flex'; loaderText.textContent = text || 'Loadingâ€¦'; emptyState.style.display='none'; cardsEl.style.display='none'; }
function hideLoader(){ loader.style.display='none'; emptyState.style.display='none'; cardsEl.style.display='grid'; }
function showEmpty(){ cardsEl.innerHTML=''; emptyState.style.display='block'; loader.style.display='none'; }

// search handling (debounced)
const onSearch = debounce(()=>{
  // when searching, combine all datasets to search globally
  const all = Object.keys(datasets).reduce((acc,k)=> acc.concat(datasets[k].diseases||[]), []);
  renderCards(all);
}, 200);
searchInput.addEventListener('input', onSearch);

// segment clicks (head/torso/limbs/skin)
segmentButtons.forEach(btn=> btn.addEventListener('click', ()=>{
  segmentButtons.forEach(b=> b.classList.toggle('active', b===btn));
  currentFilter = btn.getAttribute('data-seg');
  const all = Object.keys(datasets).reduce((acc,k)=> acc.concat(datasets[k].diseases||[]), []);
  renderCards(all);
}));

// diagram zone click handling
Array.from(document.querySelectorAll('.zone')).forEach(g=> g.addEventListener('click', ()=>{
  const seg = g.getAttribute('data-zone');
  // toggle active segment button
  segmentButtons.forEach(b=> b.classList.toggle('active', b.getAttribute('data-seg')===seg));
  currentFilter = seg;
  const all = Object.keys(datasets).reduce((acc,k)=> acc.concat(datasets[k].diseases||[]), []);
  renderCards(all);
}));

// language rotate
langBtn.addEventListener('click', async ()=>{
  const idx = availableLangs.indexOf(currentLang);
  currentLang = availableLangs[(idx+1) % availableLangs.length];
  await loadLocale(currentLang);
  langBtn.textContent = currentLang.toUpperCase();
  // reapply UI strings
  loaderText.textContent = t('loading') || 'Loadingâ€¦';
  searchInput.placeholder = t('search_placeholder') || 'Search disease, remedy or body part...';
});

// initial focus helpers
window.addEventListener('keydown', (e)=>{ if(e.key==='/' && document.activeElement!==searchInput){ e.preventDefault(); searchInput.focus(); } });

</script>
</body>
</html>
