<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<link rel="manifest" href="./manifest.json">
<title>Tibb-e-Nabvi â€” Explorer</title>
<style>
:root{
  --bg-light: #fbfdf9;
  --panel-light: #ffffff;
  --text-light: #0b1a1a;
  --muted-light: #556066;
  --accent: #10b981; /* green accent */
  --glass-light: rgba(2,6,8,0.02);

  --bg-dark:#071026;
  --panel-dark:#0b1220;
  --text-dark:#e6eef6;
  --muted-dark:#94a3b8;
  --glass-dark: rgba(255,255,255,0.03);

  --radius:12px;
  --shadow: 0 6px 20px rgba(2,6,8,0.06);
  font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
  color-scheme: light dark;
}

/* Theme-aware variables */
:root[data-theme="light"]{
  --bg: var(--bg-light);
  --panel: var(--panel-light);
  --text: var(--text-light);
  --muted: var(--muted-light);
  --glass: var(--glass-light);
  --glass-2: rgba(2,6,8,0.01);
  --glass-border: rgba(2,6,8,0.06);
}
:root[data-theme="dark"]{
  --bg: var(--bg-dark);
  --panel: var(--panel-dark);
  --text: var(--text-dark);
  --muted: var(--muted-dark);
  --glass: var(--glass-dark);
  --glass-2: rgba(255,255,255,0.02);
  --glass-border: rgba(255,255,255,0.04);
}

*{box-sizing:border-box}
html,body{height:100%; margin:0; background:var(--bg); color:var(--text); -webkit-tap-highlight-color: transparent;}
.app{min-height:100vh; display:flex; flex-direction:column; gap:10px; padding:12px;}

/* Header */
.header{display:flex; gap:10px; align-items:center; justify-content:space-between;}
.brand{display:flex; gap:10px; align-items:center}
.logo{width:44px; height:44px; border-radius:10px; background:linear-gradient(135deg,var(--accent),#7c3aed); display:flex; align-items:center; justify-content:center; font-weight:700; color:#021; box-shadow:var(--shadow);}
.title-block{display:flex; flex-direction:column}
.title{font-weight:800; font-size:16px}
.subtitle{font-size:13px; color:var(--muted)}

/* Controls */
.controls{display:flex; gap:8px; align-items:center}
.btn{background:var(--panel); border:1px solid var(--glass); padding:10px 12px; border-radius:10px; cursor:pointer; color:var(--muted); font-weight:700; font-size:14px; box-shadow:var(--shadow)}
.icon-btn{display:inline-flex; align-items:center; justify-content:center; width:44px; height:44px; border-radius:10px; font-weight:700}
.lang-btn{min-width:44px; padding:8px 10px}

/* Search and tabs */
.search{margin-top:6px}
.search input{width:100%; padding:12px 14px; border-radius:12px; border:1px solid var(--glass-border, rgba(0,0,0,0.06)); background:var(--panel); color:var(--text); outline:none; font-size:15px}

.tabs{display:flex; gap:8px; overflow-x:auto; padding:8px 2px; margin-top:6px; -webkit-overflow-scrolling:touch;}
.tabs::-webkit-scrollbar{display:none}
.tab{flex:0 0 auto; padding:10px 12px; border-radius:12px; background:transparent; border:1px solid transparent; font-size:14px; cursor:pointer; color:var(--muted)}
.tab.active{background:linear-gradient(90deg, rgba(16,185,129,0.12), rgba(124,58,237,0.04)); border:1px solid var(--glass-border); color:var(--text); box-shadow:var(--shadow)}

/* Content */
.content{flex:1; overflow:auto; padding:6px; display:grid; grid-template-columns: 1fr; gap:10px; margin-bottom:6px;}
.card{display:flex; gap:10px; align-items:flex-start; padding:12px; border-radius:12px; background:var(--panel); border:1px solid var(--glass); box-shadow:var(--shadow)}
.thumb{width:84px; height:84px; border-radius:10px; background:var(--glass-2); border:1px solid rgba(0,0,0,0.04); display:flex; align-items:center; justify-content:center; overflow:hidden; flex-shrink:0}
.thumb img{width:100%; height:100%; object-fit:cover}
.card-body{flex:1}
.card-title{font-weight:700; font-size:15px; margin-bottom:6px}
.remedy{font-size:13px; color:var(--muted); margin-bottom:6px}
.meta{display:flex; gap:6px; flex-wrap:wrap; margin-bottom:6px}
.pill{background:transparent; border:1px solid var(--glass-border); padding:6px 8px; border-radius:999px; font-size:12px; color:var(--muted)}

.details{font-size:13px; color:var(--text); line-height:1.35; margin-top:6px}
.footer{display:flex; gap:8px; align-items:center; margin-top:8px; justify-content:space-between}

/* Loader */
.loader{display:flex; align-items:center; gap:10px; padding:18px; justify-content:center}
.spinner{width:34px;height:34px;border-radius:999px;border:4px solid rgba(0,0,0,0.06);border-top-color:var(--accent);animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

.empty{padding:30px; text-align:center; color:var(--muted)}

/* Larger screens */
@media(min-width:900px){ .app{flex-direction:row; padding:20px} .leftcol{width:300px} .content{grid-template-columns: repeat(auto-fill,minmax(320px,1fr));} .tabs{flex-direction:column; width:100%} .search input{width:260px} }
</style>
</head>
<body>
<div class="app" id="app" data-theme="light">
  <div style="display:flex; flex-direction:column; gap:8px; width:100%">

    <div class="header">
      <div class="brand">
        <div class="logo">T</div>
        <div class="title-block">
          <div class="title" id="appTitle">Tibb-e-Nabvi Explorer</div>
          <div class="subtitle" id="appSub">Traditional remedies â€” visual edition</div>
        </div>
      </div>

      <div class="controls">
        <button id="themeToggle" class="icon-btn btn" title="Toggle theme">ðŸŒ™</button>
        <button id="langBtn" class="btn lang-btn">EN</button>
        <button id="installBtn" class="btn" style="display:none">Install</button>
      </div>
    </div>

    <div class="search"><input id="searchInput" placeholder="Search disease or remedy..." aria-label="Search"></div>
    <div class="tabs" id="tabs" role="tablist"></div>
  </div>

  <main class="content" id="contentArea">
    <div class="loader" id="loader"><div class="spinner"></div><div id="loaderText">Loadingâ€¦</div></div>
    <div class="empty" id="emptyState" style="display:none">Select a body part to begin or search above.</div>
  </main>
</div>

<script>
// Mobile-first PWA UI (light default) with persistent theme, improved loading and error handling
const APP_TITLE = "Tibb-e-Nabvi Explorer";
const APP_SUB = "Traditional remedies â€” visual edition";

// Elements
const app = document.getElementById('app');
const tabsEl = document.getElementById('tabs');
const contentArea = document.getElementById('contentArea');
const loader = document.getElementById('loader');
const loaderText = document.getElementById('loaderText');
const emptyState = document.getElementById('emptyState');
const searchInput = document.getElementById('searchInput');
const themeToggle = document.getElementById('themeToggle');
const langBtn = document.getElementById('langBtn');
const installBtn = document.getElementById('installBtn');
const appTitle = document.getElementById('appTitle');
const appSub = document.getElementById('appSub');

let datasets = {};
let currentPart = null;
let indexFiles = [];

// i18n (loads locales/<code>.json)
const availableLangs = ['en','ar','ur','zh','fr','ja','es','ru'];
let locales = {};
let currentLang = 'en';

async function loadLocale(code){
  if(locales[code]) return locales[code];
  try{
    const r = await fetch('./locales/'+code+'.json');
    if(!r.ok) throw new Error('locale not found');
    const j = await r.json();
    locales[code] = j;
    return j;
  }catch(e){
    locales[code] = locales['en'] || {};
    return locales[code];
  }
}
function t(key){ return (locales[currentLang] && locales[currentLang][key]) || (locales['en'] && locales['en'][key]) || key; }

// Theme: persist user's choice
function applyTheme(theme){
  document.documentElement.setAttribute('data-theme', theme);
  app.setAttribute('data-theme', theme);
  localStorage.setItem('tibb_theme', theme);
  themeToggle.textContent = theme === 'dark' ? 'â˜€ï¸' : 'ðŸŒ™';
}
function initTheme(){
  const saved = localStorage.getItem('tibb_theme');
  if(saved){ applyTheme(saved); return; }
  // default light
  applyTheme('light');
}
themeToggle.addEventListener('click', ()=>{
  const current = app.getAttribute('data-theme') === 'dark' ? 'dark' : 'light';
  applyTheme(current === 'dark' ? 'light' : 'dark');
});

// Install prompt handling
let deferredPrompt = null;
window.addEventListener('beforeinstallprompt', (e)=>{ e.preventDefault(); deferredPrompt = e; installBtn.style.display='inline-block'; });
installBtn.addEventListener('click', async ()=>{ if(!deferredPrompt) return; deferredPrompt.prompt(); const choice = await deferredPrompt.userChoice; deferredPrompt = null; installBtn.style.display='none'; });

// service worker registration (only on https or gh-pages)
if('serviceWorker' in navigator){
  navigator.serviceWorker.register('./service-worker.js').then(()=> console.log('SW registered')).catch(e=> console.warn('SW failed', e));
}

// initialize
(async function init(){
  appTitle.textContent = APP_TITLE;
  appSub.textContent = APP_SUB;
  initTheme();
  await loadLocale('en');
  // detect preferred language
  const navLang = navigator.language ? navigator.language.split('-')[0] : 'en';
  if(availableLangs.includes(navLang)) currentLang = navLang;
  await loadLocale(currentLang);
  langBtn.textContent = currentLang.toUpperCase();

  // fetch index.json from data folder
  showLoader(t('loading') || 'Loadingâ€¦');
  try{
    const idxRes = await fetch('data/index.json');
    if(!idxRes.ok) throw new Error('index.json not found');
    const idx = await idxRes.json();
    indexFiles = idx.files || idx || [];
    await loadDatasets(indexFiles);
    hideLoader();
    renderTabs();
    if(Object.keys(datasets).length>0){
      const first = Object.keys(datasets)[0];
      selectPart(first);
    } else {
      emptyState.style.display='block';
    }
  }catch(err){
    console.error('Failed to load data', err);
    showLoader('Failed to load data â€” check that /data/index.json is present and publicly accessible.');
    loader.style.cursor='pointer';
    loader.onclick = ()=> location.reload();
  }
})();

async function loadDatasets(files){
  for(const f of files){
    try{
      const res = await fetch(f);
      if(!res.ok) { console.warn('failed', f); continue; }
      const j = await res.json();
      datasets[f] = j;
    }catch(e){ console.warn('error loading', f, e); }
  }
}

function renderTabs(){
  tabsEl.innerHTML = '';
  for(const fname of Object.keys(datasets)){
    const d = datasets[fname];
    const btn = document.createElement('button');
    btn.className = 'tab';
    btn.textContent = d.body_part || fname.replace('.json','');
    btn.title = fname;
    btn.onclick = ()=> selectPart(fname);
    tabsEl.appendChild(btn);
  }
  // allow first tab to overflow scroll into view on mobile
  tabsEl.scrollLeft = 0;
}

function selectPart(fname){
  currentPart = fname;
  [...tabsEl.children].forEach(c=> c.classList.toggle('active', c.title===fname));
  const data = datasets[fname] || {diseases:[]};
  renderContent(data.diseases || []);
  // scroll content to top on selection (mobile UX)
  contentArea.scrollTop = 0;
}

function renderContent(list){
  contentArea.innerHTML = '';
  if(!list || list.length===0){ contentArea.innerHTML = '<div class="empty">'+t('no_matches')+'</div>'; return; }
  const q = (searchInput.value||'').trim().toLowerCase();
  let shown=0;
  for(const item of list){
    const title = item.disease || 'â€”';
    const remedy = item.remedy || '';
    const hay = (title+' '+remedy+' '+(item.remedy_description||'')+' '+(item.method||'')).toLowerCase();
    if(q && !hay.includes(q)) continue;
    shown++;
    const card = document.createElement('article'); card.className='card';
    const thumb = document.createElement('div'); thumb.className='thumb';
    if(item.remedy_image_url){ const img = document.createElement('img'); img.src = item.remedy_image_url; img.alt = item.remedy || title; thumb.appendChild(img); }
    else { thumb.innerHTML = '<div style="padding:8px;color:var(--muted)">'+t('no_image')+'</div>'; }
    const body = document.createElement('div'); body.className='card-body';
    const h = document.createElement('div'); h.className='card-title'; h.textContent = title;
    const r = document.createElement('div'); r.className='remedy'; r.innerHTML = '<strong>Remedy:</strong> ' + (remedy || 'â€”');
    const meta = document.createElement('div'); meta.className='meta';
    if(item.dose) meta.appendChild(makePill((t('dose')||'Dose')+': '+item.dose));
    if(item.timing) meta.appendChild(makePill((t('timing')||'Timing')+': '+item.timing));
    if(item.source) meta.appendChild(makePill((t('source')||'Source')));
    const details = document.createElement('div'); details.className='details';
    details.innerHTML = '<div style="color:var(--muted); margin-bottom:6px;">'+escapeHtml(item.remedy_description||'')+'</div><div><strong>Method:</strong> '+escapeHtml(item.method||'â€”')+'</div>';
    const footer = document.createElement('div'); footer.className='footer';
    const more = document.createElement('a'); more.className='btn'; more.textContent = t('more_images') || 'More images'; more.href = getMoreImagesLink(item.remedy_description); more.target='_blank';
    const dl = document.createElement('button'); dl.className='btn'; dl.textContent = t('download')||'Download'; dl.onclick = ()=> downloadJSON(item);
    footer.appendChild(more); footer.appendChild(dl);
    body.appendChild(h); body.appendChild(r); body.appendChild(meta); body.appendChild(details); body.appendChild(footer);
    card.appendChild(thumb); card.appendChild(body);
    contentArea.appendChild(card);
  }
  if(shown===0) contentArea.innerHTML = '<div class="empty">'+t('no_matches')+'</div>';
}

function makePill(text){ const s=document.createElement('span'); s.className='pill'; s.textContent=text; return s; }
function escapeHtml(s){ if(!s) return ''; return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\\n/g,'<br/>'); }
function getMoreImagesLink(desc){ if(!desc) return 'https://commons.wikimedia.org'; const m = desc.match(/More images:\\s*(https?:\\/\\/[^\\s]+)/i); return m? m[1] : 'https://commons.wikimedia.org'; }

searchInput.addEventListener('input', ()=> { if(currentPart) renderContent(datasets[currentPart].diseases || []); });

// language rotate
langBtn.addEventListener('click', async ()=>{
  const idx = availableLangs.indexOf(currentLang);
  currentLang = availableLangs[(idx+1) % availableLangs.length];
  await loadLocale(currentLang);
  applyLocaleUI();
  renderContent(datasets[currentPart].diseases || []);
});

function applyLocaleUI(){
  appTitle.textContent = t('app_title') || APP_TITLE;
  appSub.textContent = t('subtitle') || APP_SUB;
  searchInput.placeholder = t('search_placeholder') || 'Search disease or remedy...';
  loaderText.textContent = t('loading') || 'Loadingâ€¦';
  emptyState.textContent = t('select_prompt') || 'Select a body part to begin or search above.';
  langBtn.textContent = currentLang.toUpperCase();
}

// download single entry's JSON (current dataset file)
function downloadJSON(item){
  if(!currentPart) return;
  const data = datasets[currentPart];
  const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = (data.body_part || 'data') + '.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}

function showLoader(text){ loader.style.display='flex'; loaderText.textContent = text || 'Loadingâ€¦'; emptyState.style.display='none'; }
function hideLoader(){ loader.style.display='none'; emptyState.style.display='none'; }

// keyboard accessibility: focus first tab on load
window.addEventListener('keydown', (e)=>{
  if(e.key === '/' && document.activeElement !== searchInput){
    e.preventDefault(); searchInput.focus();
  }
});

// apply locale UI initially when locales loaded
async function applyLocaleOnStart(){ await loadLocale(currentLang); applyLocaleUI(); }
applyLocaleOnStart();

</script>
</body>
</html>
